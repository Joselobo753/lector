<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Patentes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    #resultado { white-space: pre-wrap; }
    input[type="text"] { width: 100%; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">Don Juan 24 sep</h1>

    <!-- NAVEGACIÓN -->
    <ul class="nav nav-tabs mb-4" id="tabNav">
      <li class="nav-item"><a class="nav-link active" href="#buscar" data-bs-toggle="tab">Buscar</a></li>
      <li class="nav-item"><a class="nav-link" href="#morosos" data-bs-toggle="tab">Morosos</a></li>
    </ul>

    <div class="tab-content">
      <!-- PESTAÑA BUSCAR -->
      <div class="tab-pane fade show active" id="buscar">
        <div class="mb-3">
          <label for="busquedaInput" class="form-label">Ingrese patente o nombre:</label>
          <div class="row g-2">
            <div class="col-8 col-sm-9">
              <input type="text" id="busquedaInput" class="form-control" placeholder="Ej: a096ztl o Facundo Sillero" />
            </div>
            <div class="col-4 col-sm-3">
              <button class="btn btn-success w-100" onclick="buscar()">Buscar</button>
            </div>
          </div>
        </div>
        <div id="resultado" class="alert alert-secondary">Listo para búsqueda.</div>
        <div class="accordion" id="accordionPagos"></div>
      </div>

      <!-- PESTAÑA MOROSOS -->
      <div class="tab-pane fade" id="morosos">
        <h4>Hoy es <span id="fechaActual"></span></h4>
        <!-- DEUDORES MES PASADO -->
        <div class="mb-4">
          <h5>Deudores del mes pasado</h5>
          <table class="table table-striped">
            <thead><tr><th>Nombre</th><th>Patente</th><th>Último Pago</th><th>Notificar</th></tr></thead>
            <tbody id="tblMesPasado"></tbody>
          </table>
        </div>
        <!-- TABLAS DE ATRASOS -->
        <div class="mb-4">
          <h5>Atrasados 5 días o más</h5>
          <table class="table table-striped">
            <thead><tr><th>Nombre</th><th>Patente</th><th>Vencimiento</th><th>Último Pago</th><th>Notificar</th></tr></thead>
            <tbody id="tblAtraso5"></tbody>
          </table>
        </div>
        <div class="mb-4">
          <h5>Atrasados 10 días o más</h5>
          <table class="table table-striped">
            <thead><tr><th>Nombre</th><th>Patente</th><th>Vencimiento</th><th>Último Pago</th><th>Notificar</th></tr></thead>
            <tbody id="tblAtraso10"></tbody>
          </table>
        </div>
        <div class="mb-4">
          <h5>Atrasados 15 días o más</h5>
          <table class="table table-striped">
            <thead><tr><th>Nombre</th><th>Patente</th><th>Vencimiento</th><th>Último Pago</th><th>Notificar</th></tr></thead>
            <tbody id="tblAtraso15"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyEzQW3T9V81EOMjCmuYjiX5_VJlVHs2y3VvOjroMpNfEFpLAuHM-jVP6-VmhJkYOUI/exec';
    const mesesOrden = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    let cache = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const hoy = new Date();
      document.getElementById('fechaActual').textContent = hoy.toLocaleDateString('es-AR', { day: '2-digit', month: 'long', year: 'numeric' });
      await cargarCache();
      cargarMorosos(hoy);
    });

    // ------------------ CACHÉ ------------------
    async function cargarCache() {
      if (!cache) cache = await fetch(API_URL).then(r=>r.json());
    }

    // ------------------ BÚSQUEDA ------------------
    function buscar() {
      const input = document.getElementById('busquedaInput').value.trim().toLowerCase();
      if (!input) return;
      const data = cache || [];
      const resultados = data.filter(row => {
        const id = row.id?.toLowerCase()||'';
        const nombre = row.Nombre?.toLowerCase()||'';
        return id === input || nombre.includes(input);
      });
      const resultadoDiv = document.getElementById('resultado');
      const accordion = document.getElementById('accordionPagos');
      accordion.innerHTML = '';
      if (!resultados.length) {
        return resultadoDiv.textContent = 'No se encontró coincidencia.';
      }
      resultadoDiv.textContent = `Coincidencias: ${resultados.length}`;
      resultados.forEach((r,i)=> accordion.innerHTML += generarCard(r,i));
    }

    // ------------------ GENERADOR DE ACORDEÓN ------------------
    function generarCard(coinc, idx) {
      const pagosArr = Object.entries(coinc.pagos||{}).sort((a,b)=> mesesOrden.indexOf(b[0]) - mesesOrden.indexOf(a[0]));
      const [ultimoMes, ultimoVal] = pagosArr[0]||['Sin datos','Sin pagos'];
      return `
        <div class="accordion-item p-2">
          <h2 class="accordion-header" id="heading${idx}">
             ${coinc.Nombre} — Patente: ${coinc.id} 
             <p>Vencimiento: ${coinc.vencimiento}</p>
              
            <button class="accordion-button collapsed border border-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${idx}" aria-expanded="false" aria-controls="collapse${idx}">
             <p><strong>Último pago:</strong> ${ultimoMes} — ${ultimoVal}</p>
            </button>
          </h2>
          <div id="collapse${idx}" class="accordion-collapse collapse" aria-labelledby="heading${idx}" data-bs-parent="#accordionPagos">
            <div class="accordion-body">
             
              <ul>
                ${pagosArr.map(([mes, val])=>`<li>${mes}: ${val}</li>`).join('')}
              </ul>
              
            </div>
          
          </div>
            <button class="btn btn-success mt-2" onclick="enviarWhatsApp('${coinc.Telefono}','${coinc.Nombre}','${coinc.vencimiento}')">Notificar</button>
        </div>`;
    }

    // ------------------ MOROSOS ------------------
    function cargarMorosos(hoy) {
      const data = cache || [];
      const diaHoy = hoy.getDate();
      const mesIdx = hoy.getMonth();
      // Mes pasado: últimos pagos anteriores al mes anterior
      const tblMP = document.getElementById('tblMesPasado'); tblMP.innerHTML = '';
      data.forEach(row => {
        const pagosArr = Object.entries(row.pagos||{}).sort((a,b)=> mesesOrden.indexOf(b[0]) - mesesOrden.indexOf(a[0]));
        const [ultMes, ultVal] = pagosArr[0]||['',''];
        const idxUlt = mesesOrden.indexOf(ultMes);
        if (idxUlt <= mesIdx - 2) {
          tblMP.innerHTML += `<tr><td>${row.Nombre}</td><td>${row.id}</td><td>${ultMes} - ${ultVal}</td><td><button class='btn btn-sm btn-success' onclick="enviarWhatsApp('${row.Telefono}','${row.Nombre}','${row.vencimiento}')">Notificar</button></td></tr>`;
        }
      });
      // Atrasos por días
      [5,10,15].forEach(days => {
        const tbody = document.getElementById(`tblAtraso${days}`); tbody.innerHTML = '';
        data.forEach(row => {
          const venc = Number(row.vencimiento);
          if (!isNaN(venc) && (diaHoy - venc) >= days) {
            const pagosArr2 = Object.entries(row.pagos||{}).sort((a,b)=> mesesOrden.indexOf(b[0]) - mesesOrden.indexOf(a[0]));
            const [m,v] = pagosArr2[0]||['N/A','N/A'];
            tbody.innerHTML += `<tr><td>${row.Nombre}</td><td>${row.id}</td><td>${row.vencimiento}</td><td>${m} - ${v}</td><td><button class='btn btn-sm btn-success' onclick="enviarWhatsApp('${row.Telefono}','${row.Nombre}','${row.vencimiento}')">Notificar</button></td></tr>`;
          }
        });
      });
    }

    // ------------------ WHATSAPP ------------------
    function enviarWhatsApp(tel,nombre,venc) {
      if (!tel || tel.length<9) return alert('Teléfono inválido');
      const num = `549${tel.replace(/\D/g,'')}`;
      const msg = `Hola ${nombre}, me comunico de garderia don juan (24 de sep 629) te informo que adeudas el pago con vencimiento el día ${venc}. Por favor regulariza tu situación. ¡Gracias!;`;
      window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`, '_blank');
    
  
    }
  </script>
</body>
</html>